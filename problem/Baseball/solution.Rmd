---
title: 'Baseball'
output: html_document
---

```{r, message = FALSE}
library(Lahman)
library(tidyverse)
```

```{r}
data <- Batting %>%
  filter(AB > 0) %>%
  anti_join(Pitching, by = 'playerID') %>%
  group_by(playerID) %>%
  summarize(H = sum(H), AB = sum(AB)) %>%
  mutate(estimate = H / AB) %>%
  inner_join(Master %>%
               select(playerID, nameFirst, nameLast) %>%
               unite(name, nameFirst, nameLast, sep = ' '),
             by = 'playerID') %>%
  select(name, H, AB, estimate)
```

## Who are the best battors?

```{r}
data %>%
  arrange(desc(estimate)) %>%
  head(10)
```

## Who are the best battors, really?

```{r}
parameters <- data %>%
  filter(AB > 500) %>%
  .$estimate %>%
  MASS::fitdistr(dbeta,
                 list(shape1 = 1, shape2 = 1),
                 lower = c(0, 0)) %>%
  .$estimate
```

```{r}
data %>%
  filter(AB > 500) %>%
  ggplot(aes(estimate)) +
  geom_histogram(aes(y = ..density..), bins = 80) +
  geom_line(data = tibble(x = seq(0.15, 0.4, by = 0.01)) %>%
                     mutate(y = dbeta(x, parameters[1], parameters[2])),
            mapping = aes(x = x, y = y),
            color = 'red',
            size = 1)
```

```{r}
data %>%
  mutate(posterior = (H + parameters[1]) / (AB + sum(parameters))) %>%
  arrange(desc(posterior)) %>%
  head(10)
```

## Confidence intervals

```{r}
data %>%
  filter(AB > 500) %>%
  nest(H, AB) %>%
  mutate(test = map(data, ~ prop.test(.$H, .$AB, conf.level = 0.95)),
         lower = map_dbl(test, ~ .$conf.int[1]),
         upper = map_dbl(test, ~ .$conf.int[2])) %>%
  unnest(data) %>%
  select(name, H, AB, lower, estimate, upper)
```