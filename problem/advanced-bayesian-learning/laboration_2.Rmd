---
title: 'Lobaration 2'
output: html_document
---

```{r, message = FALSE}
library(tidyverse)

theme_set(theme_minimal())
```

```{r}
url <- 'https://raw.githubusercontent.com/mattiasvillani/AdvBayesLearnCourse/master/Labs/GalaxyData.dat'
data <- readr::read_table(url, col_names = c('Velocity'), col_types = list(Velocity = 'd'))
```

```{r}
data %>%
  ggplot(aes(Velocity)) +
  stat_ecdf() +
  labs(y = 'Empirical CDF')
```

# Direct prior

```{r}
nu_prior <- function(nu0 = 1) {
  P0.sample <- function(n) rnorm(n, mean = 20, sd = 3)
  list(P0.sample = P0.sample, nu0 = nu0)
}

nu_posterior <- function(x, nu0 = 1) {
  prior <- nu_prior(nu0)
  P0.sample <- function(n) {
    i <- rbernoulli(n, p = nu0 / (nu0 + length(x)))
    i * prior$P0.sample(n) + (1 - i) * sample(x, n, replace = TRUE)
  }
  list(P0.sample = P0.sample, nu0 = nu0 + length(x))
}

nu_sample <- function(n, nu) {
  x <- nu$P0.sample(n)
  q <- c(rbeta(n - 1, shape1 = 1, shape2 = nu$nu0), 1)
  p <- q * c(1, cumprod(1 - head(q, -1)))
  tibble(x = x, p = p)
}

plot_distribution <- function(data) {
  data %>%
    arrange(x) %>%
    mutate(p = cumsum(p)) %>%
    ggplot(aes(x, p)) +
    geom_line() +
    labs(x = 'Velocity', y = 'Sample CDF')
}
```

```{r}
set.seed(42)

tibble(nu0 = c(1, 10, 100)) %>%
  mutate(data = map(nu0, ~ nu_sample(n = 10000, nu = nu_prior(.x)))) %>%
  unnest(data) %>%
  mutate(nu0 = str_c('Volume = ', nu0)) %>%
  group_by(nu0) %>%
  plot_distribution() +
  facet_wrap(vars(nu0), ncol = 1)
```

```{r}
set.seed(42)

tibble(nu0 = c(1, 10, 100)) %>%
  mutate(data = map(nu0, ~ nu_sample(n = 10000,
                                     nu = nu_posterior(data$Velocity, .x)))) %>%
  unnest(data) %>%
  mutate(nu0 = str_c('Volume = ', nu0)) %>%
  group_by(nu0) %>%
  plot_distribution() +
  facet_wrap(vars(nu0), ncol = 1)
```

# Mixing prior

```{r}
P0_prior <- function(mu0 = 0, n0 = 1, alpha0 = 1, beta0 = 0.5) {
  sample <- function(n) {
    tau <- rgamma(n, alpha0, beta0)
    mu <- rnorm(n, mu0, n0 * tau)
    tibble(mu = mu, tau = tau)
  }
  list(sample = sample)
}

P0_posterior <- function(x, mu0 = 0, n0 = 1, alpha0 = 1, beta0 = 0.5) {
  n1 <- length(x)
  mu1 <- mean(x)
  s1 <- sqrt((n1 - 1) / n1) * sd(x)
  P0_prior(
    mu0 = n0 * mu0 / (n0 + n1) + n1 * mu1 / (n0 + n1),
    n0 = n0 + n1,
    alpha0 = alpha0 + n1 / 2,
    beta0 = beta0 + 0.5 * (n0 * n1 * (mu1 - mu0)^2 / (n0 + n1) + n1 * s1^2)
  )
}

P1_density <- function(x, theta) {
  pnorm(x, theta$mu, sqrt(1 / theta$tau))
}

update_k <- function(x, state) {
  p <- rep(state$p, state$n)
  x <- rep(x, each = state$m)
  theta <- state$theta %>% slice(rep(seq(state$m), state$n))
  p <- matrix(p * P1_density(x, theta), nrow = state$m, ncol = state$n)
  p <- p / colSums(p)
  apply(p, 2, function(p) sample(seq(state$m), 1, prob = p))
}

update_p <- function(x, state) {
  counts <- as.data.frame(table(state$k))
  i <- counts[ , 1]
  i <- as.numeric(levels(i))[i]
  n <- rep(0, state$m)
  n[i] <- counts[ , 2]
}
```

```{r}
P0_prior(mu0 = mean(data$Velocity))$sample(1000) %>%
  ggplot() +
  geom_density(aes(mu))
```

```{r}
P0_posterior(data$Velocity, mu0 = mean(data$Velocity))$sample(1000) %>%
  ggplot() +
  geom_density(aes(mu))
```

```{r}
set.seed(42)

m <- 50
n <- nrow(data)

state <- list(
  m = m,
  n = n,
  p = rep(1 / m, m),
  k = sample(seq(m), n, replace = TRUE),
  theta = P0_prior(mu0 = mean(data$Velocity))$sample(m)
)

update_k(data$Velocity, state)
update_p(data$Velocity, state)
```
