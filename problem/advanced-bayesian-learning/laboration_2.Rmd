---
title: 'Lobaration 2'
output: html_document
---

```{r, message = FALSE}
library(tidyverse)

theme_set(theme_minimal())
```

```{r}
url <- 'https://raw.githubusercontent.com/mattiasvillani/AdvBayesLearnCourse/master/Labs/GalaxyData.dat'
data <- readr::read_table(url, col_names = c('Velocity'), col_types = list(Velocity = 'd'))
```

```{r}
data %>%
  ggplot(aes(Velocity)) +
  stat_ecdf() +
  labs(y = 'Empirical CDF')
```

```{r}
plot_distribution <- function(data) {
  data %>%
    arrange(x) %>%
    mutate(p = cumsum(p)) %>%
    ggplot(aes(x, p)) +
    geom_line() +
    labs(x = 'Velocity', y = 'Sample CDF')
}

posterior_measure <- function(volume, x) {
  prior <- prior_measure(volume)
  normalized <- function(n) {
    i <- rbernoulli(n, p = volume / (volume + length(x)))
    i * prior$normalized(n) + (1 - i) * sample(x, n, replace = TRUE)
  }
  list(normalized = normalized, volume = volume + length(x))
}

prior_measure <- function(volume) {
  normalized <- function(n) rnorm(n, mean = 20, sd = 3)
  list(normalized = normalized, volume = volume)
}

sample_distribution <- function(n, alpha) {
  x <- alpha$normalized(n)
  v <- c(rbeta(n - 1, shape1 = 1, shape2 = alpha$volume), 1)
  w <- c(1, cumprod(1 - head(v, -1)))
  tibble(x = x, p = v * w)
}
```

```{r}
set.seed(42)

tibble(volume = c(1, 10, 100)) %>%
  mutate(data = map(volume, ~ sample_distribution(n = 10000,
                                                  alpha = prior_measure(.x)))) %>%
  unnest(data) %>%
  mutate(volume = str_c('volume = ', volume)) %>%
  group_by(volume) %>%
  plot_distribution() +
  facet_wrap(vars(volume), ncol = 1)
```

```{r}
set.seed(42)

tibble(volume = c(1, 10, 100)) %>%
  mutate(data = map(volume, ~ sample_distribution(n = 10000,
                                                  alpha = posterior_measure(.x, data$Velocity)))) %>%
  unnest(data) %>%
  mutate(volume = str_c('volume = ', volume)) %>%
  group_by(volume) %>%
  plot_distribution() +
  facet_wrap(vars(volume), ncol = 1)
```
