---
title: 'Bayesian A/B testing'
output: html_document
---

```{r, message = FALSE}
if (!'conversion.rate' %in% rownames(installed.packages())) {
  library(devtools)
  install_github('chain-rule/conversion-rate')
}

library(conversion.rate)
library(tidyverse)

source('plotting.R')
theme_set(theme_light())
```

```{r}
compute_density <- function(a_alpha, a_beta, b_alpha, b_beta) {
  tibble(Conversion = seq(0, 0.1, length.out = 1000)) %>%
  crossing(Group = c('A', 'B')) %>%
  mutate(Density = dbeta(Conversion,
                         if_else(Group == 'A', a_alpha, b_alpha),
                         if_else(Group == 'A', a_beta, b_beta)))
}
```

```{r}
replication_num <- 10000
day_num <- 21
daily_num <- 1000

a_alpha_prior <- 20
a_beta_prior <- 980
a_rate <- a_alpha_prior / (a_alpha_prior + a_beta_prior)

b_effect <- 0
b_alpha_prior <- a_alpha_prior / 10
b_beta_prior <- a_beta_prior / 10

loss_threshold <- 0.01 * a_rate
```

## Prior distributions

```{r}
compute_density(a_alpha_prior, a_beta_prior, b_alpha_prior, b_beta_prior) %>%
  ggplot(aes(Conversion, Density, color = Group)) +
  geom_line() +
  theme(legend.title = element_blank())
```

## Simulation results

```{r}
set.seed(2018-12-01)

data <- tibble(replication = seq_len(replication_num)) %>%
  mutate(a_rate = a_rate,
         b_effect = b_effect,
         a_alpha_prior = a_alpha_prior,
         a_beta_prior = a_beta_prior,
         b_alpha_prior = b_alpha_prior,
         b_beta_prior = b_beta_prior) %>%
  simulate(day_num = day_num,
           daily_num = daily_num,
           approximate = TRUE) %>%
  group_by(replication) %>%
  mutate(passed_any = min(expected_loss) < loss_threshold,
         passed_end = last(expected_loss) < loss_threshold) %>%
  ungroup()

data %>%
  summarize(greater_probability = mean(greater_probability),
            passed_any = mean(passed_any))
```

```{r, warning = FALSE}
data %>%
  filter(replication %in% sample(replication_num, 100)) %>%
  group_by(replication) %>%
  filter(head(cumsum(c(1, expected_loss) < loss_threshold), -1) == 0) %>%
  plot(line = loss_threshold) +
  scale_y_log10() +
  ylab('Posterior expected loss')
```

# Posterior distributions

```{r, message = FALSE}
data_part <- data %>%
  filter(replication %in% sample(replication_num, 1)) %>%
  group_by(replication) %>%
  arrange(day) %>%
  filter(head(cumsum(c(1, expected_loss) < loss_threshold), -1) == 0) %>%
  summarize(day = last(day),
            a_alpha_posterior = last(a_alpha_posterior),
            a_beta_posterior = last(a_beta_posterior),
            b_alpha_posterior = last(b_alpha_posterior),
            b_beta_posterior = last(b_beta_posterior)) %>%
  nest(a_alpha_posterior,
       a_beta_posterior,
       b_alpha_posterior,
       b_beta_posterior) %>%
  mutate(data = map(data, ~ compute_density(.$a_alpha_posterior,
                                            .$a_beta_posterior,
                                            .$b_alpha_posterior,
                                            .$b_beta_posterior))) %>%
  unnest()

data_peak <- data_part %>%
  group_by(replication, Group) %>%
  arrange(desc(Density)) %>%
  top_n(1) %>%
  ungroup() %>%
  mutate(Density = Density + 0.05 * max(Density))

data_part %>%
  ggplot(aes(Conversion, Density, color = Group)) +
  geom_line(aes(group = interaction(replication, Group))) +
  geom_text(data = data_peak, aes(label = day), show.legend = FALSE) +
  theme(legend.title = element_blank())
```
