---
title: 'Bayesian A/B testing'
output: html_document
---

```{r, message = FALSE}
library(devtools)
library(tidyverse)
load_all('simulation')

source('plotting.R')
theme_set(theme_light())
```

```{r}
compute_density <- function(a_alpha, a_beta, b_alpha, b_beta) {
  tibble(Conversion = seq(0, 0.1, length.out = 1000)) %>%
  crossing(Group = c('A', 'B')) %>%
  mutate(Density = dbeta(Conversion,
                         if_else(Group == 'A', a_alpha, b_alpha),
                         if_else(Group == 'A', a_beta, b_beta)))
}
```

```{r}
replication_num <- 10000
day_num <- 21
daily_num <- 1000

base_alpha <- 20
base_beta <- 980
base_conversion <- base_alpha / (base_alpha + base_beta)

case_effect <- 0
case_alpha <- base_alpha / 10
case_beta <- base_beta / 10
care_threshold <- 0.01 * base_conversion
```

## Prior distributions

```{r}
compute_density(base_alpha, base_beta, case_alpha, case_beta) %>%
  ggplot(aes(Conversion, Density, color = Group)) +
  geom_line() +
  theme(legend.title = element_blank())
```

## Simulation results

```{r}
set.seed(2018-12-01)

data <- tibble(replication = seq_len(replication_num)) %>%
  mutate(a_rate = base_conversion,
         b_effect = case_effect,
         a_alpha_prior = base_alpha,
         a_beta_prior = base_beta,
         b_alpha_prior = case_alpha,
         b_beta_prior = case_beta) %>%
  simulate(day_num = day_num,
           daily_num = daily_num,
           approximate = TRUE) %>%
  group_by(replication) %>%
  mutate(pass_any = min(expected_loss) < care_threshold,
         pass_end = last(expected_loss) < care_threshold) %>%
  ungroup()

data %>%
  { mean(.$pass_any) }
```

```{r, warning = FALSE}
data_part <- data %>%
  filter(replication %in% sample(replication_num, 100)) %>%
  group_by(replication) %>%
  mutate(pass_any = min(expected_loss) < care_threshold,
         pass_end = last(expected_loss) < care_threshold)

data_peek <- data_part %>%
  filter(expected_loss < care_threshold) %>%
  slice(1)

data_part %>%
  filter(head(cumsum(c(1, expected_loss) < care_threshold), -1) == 0) %>%
  plot(color = 'pass_any', y_aestetic = 'expected_loss', line = care_threshold) +
  geom_point(data = data_peek, color = 'red') +
  scale_y_log10() +
  ylab('Posterior expected loss')
```

# Posterior distributions

```{r}
data %>%
  filter(replication %in% sample(replication_num, 1)) %>%
  group_by(replication) %>%
  arrange(day) %>%
  filter(head(cumsum(c(1, expected_loss) < care_threshold), -1) == 0) %>%
  summarize(a_alpha_posterior = last(a_alpha_posterior),
            a_beta_posterior = last(a_beta_posterior),
            b_alpha_posterior = last(b_alpha_posterior),
            b_beta_posterior = last(b_beta_posterior)) %>%
  nest(a_alpha_posterior,
       a_beta_posterior,
       b_alpha_posterior,
       b_beta_posterior) %>%
  mutate(data = map(data, ~ compute_density(.$a_alpha_posterior,
                                            .$a_beta_posterior,
                                            .$b_alpha_posterior,
                                            .$b_beta_posterior))) %>%
  unnest() %>%
  ggplot(aes(Conversion, Density, color = Group)) +
  geom_line(aes(group = interaction(replication, Group))) +
  theme(legend.title = element_blank())
```