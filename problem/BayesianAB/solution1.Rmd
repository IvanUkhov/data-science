---
title: 'Bayesian A/B testing'
output: html_document
---

```{r, message = FALSE}
library(devtools)
library(tidyverse)
load_all('simulation')

source('plotting.R')
source('testing.R')
theme_set(theme_light())
```

```{r}
replication_num <- 10000
day_num = 20
daily_num <- 10000
conversion_base <- 0.001
significance_level <- 0.05
```

# No effect

```{r}
set.seed(2018 - 12 - 01)

data_null <- tibble(replication = seq_len(replication_num)) %>%
  simulate(day_num = day_num,
           daily_num = daily_num,
           a_rate = conversion_base,
           b_effect = 0,
           approximate = TRUE) %>%
  mutate(p_value = vectorized_prop_test(a_success_num,
                                        a_total_num - a_success_num,
                                        b_success_num,
                                        b_total_num - b_success_num)$p.value)
```

### Waiting

```{r}
data_null %>%
  filter(day == day_num) %>%
  { mean(.$p_value < significance_level) }
```

```{r}
data <- data_null %>%
  filter(replication %in% sample(replication_num, 100)) %>%
  group_by(replication) %>%
  mutate(pass_any = min(p_value) < significance_level,
         pass_end = last(p_value) < significance_level)

data_wait <- data %>%
  filter(day == day_num, p_value < significance_level)

data_wait %>% nrow()
```

```{r}
data %>%
  plot(line = significance_level) +
  geom_point(data = data_wait, color = 'red') +
  ylab('P-value')
```

### Peeking

```{r}
data_peek <- data %>%
  filter(p_value < significance_level) %>%
  slice(1)

data_peek %>% nrow()
```

```{r}
data %>%
  filter(head(cumsum(c(1, p_value) < significance_level), -1) == 0) %>%
  plot(color = 'pass_any', line = significance_level) +
  geom_point(data = data_peek, color = 'red') +
  ylab('P-value')
```

# Negative effect

```{r}
effect_size <- 0.0001
care_threshold <- 0.1 * effect_size

data_negative <- tibble(replication = seq_len(replication_num)) %>%
  simulate(day_num = day_num,
           daily_num = daily_num,
           a_rate = conversion_base,
           b_effect = -effect_size,
           a_alpha = 10,
           b_alpha = 10,
           a_beta = 90,
           b_beta = 90,
           approximate = TRUE)

data <- data_negative %>%
  filter(replication %in% sample(replication_num, 100)) %>%
  group_by(replication, a_alpha) %>%
  mutate(pass_any = min(expected_loss) < care_threshold,
         pass_end = last(expected_loss) < care_threshold)
```

### Waiting

```{r}
data_wait <- data %>%
  filter(day == day_num, expected_loss < care_threshold)

data_wait %>% nrow()
```

```{r}
data %>%
  plot(y_aestetic = 'expected_loss', line = care_threshold) +
  geom_point(data = data_wait, color = 'red') +
  scale_y_log10() +
  ylab('Posterior expected loss')
```

### Peeking

```{r}
data_peek <- data %>%
  filter(expected_loss < care_threshold) %>%
  slice(1)

data_peek %>% nrow()
```

```{r}
data %>%
  filter(head(cumsum(c(1, expected_loss) < care_threshold), -1) == 0) %>%
  plot(color = 'pass_any',
       y_aestetic = 'expected_loss',
       line = care_threshold) +
  geom_point(data = data_peek, color = 'red') +
  scale_y_log10() +
  ylab('Posterior expected loss')
```

## Positive effect

```{r}
data_positive <- tibble(replication = seq_len(4 * replication_num)) %>%
  mutate(a_rate = rbeta(n(), 100, 99900),
         b_rate = rbeta(n(), 100, 99900),
         b_effect = b_rate - a_rate) %>%
  simulate(day_num = day_num,
           daily_num = daily_num,
           a_alpha = 100,
           b_alpha = 100,
           a_beta = 99900,
           b_beta = 99900)

data <- data_positive %>%
  arrange(replication) %>%
  group_by(replication) %>%
  slice(c(which.min(expected_loss), n())) %>%
  mutate(rule = c('Peeking', 'Waiting'))
```

```{r, warning = FALSE}
data %>%
  mutate(loss = pmax(-b_effect, 0)) %>%
  group_by(rule) %>%
  arrange(expected_loss) %>%
  mutate(cumulative_loss = cummean(loss)) %>%
  ggplot(aes(expected_loss, cumulative_loss, color = rule)) +
  geom_line() +
  geom_abline(lty = 2) +
  xlab('Expected loss') +
  ylab('Cumulative loss') +
  scale_x_log10(lim = c(1e-7, 1e-3)) +
  scale_y_log10(lim = c(1e-7, 1e-3)) +
  theme(legend.title = element_blank())
```
